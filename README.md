# Angular Monorepo

This project is meant to act as a reference for an Angular monorepo workspace consisting of multiple apps and libraries. Libraries can either be monolithic or consisting of sub-packages.

The trend seems to be use `nx` to automate these, but using another tool on top of the core build tools hides a lot of the process complexity making it hard to troubleshoot when things go wrong. I wanted to mimic the core `nx` capabilities while keeping the source as pure as possible without additional external dependencies.

That said, there's one additional dependency -- `@analogjs/\*` -- three packages that automate configuring the test environment for running the unit tests from command line (`ng test`) and from within the VSCode IDE using the Vitest official plugin. If you do not require this feature, you can skip this too. The dependent packages now look like this:

```
"dependencies": {
  "@angular/common": "^21.1.0",
  "@angular/compiler": "^21.1.0",
  "@angular/core": "^21.1.0",
  "@angular/forms": "^21.1.0",
  "@angular/platform-browser": "^21.1.0",
  "@angular/router": "^21.1.0",
  "rxjs": "~7.8.0",
  "tslib": "^2.3.0"
},
"devDependencies": {
  "@analogjs/platform": "^2.2.3",
  "@analogjs/vite-plugin-angular": "^2.2.3",
  "@analogjs/vitest-angular": "^2.2.3",
  "@angular/build": "^21.1.2",
  "@angular/cli": "^21.1.1",
  "@angular/compiler-cli": "^21.1.0",
  "jsdom": "^27.4.0",
  "ng-packagr": "^21.1.0",
  "typescript": "~5.9.2",
  "vite-tsconfig-paths": "^6.0.5",
  "vitest": "^4.0.8"
}
```

Lastly, this is for Angular v21, which uses `vitest` as its unit test framework. Integrating `vitest` with Angular & VSCode (editor of choice) in a monorepo workspace, requires a bit of tweaking to the default config generated by `ng` CLI, which is what this project and the accompanying README (this file) captures.

## Steps

1. Generate the angular workspace with `--no-create-application` command line paramter.

   ```
   $ ng new monorepo-demo --no-create-application
   ```

2. Generate the app:

   ```
   $ ng g app helloworld --project-root=apps/helloworld
   ```

   Note how we specify the project's root folder in the command line. The folder structure we employ categorizes apps and libraries under separate parent folders named `apps` and `libs` respectively.

3. Generate a library:

   ```
   $ ng g library shared --project-root=libs/shared
   ```

   Issue `ng build shared` and `ng test shared`. Both commands should not produce any errors.

4. Import the default `<lib-shared>` component into the app and add it to the app template. It should be reflected in the app UI.

5. Integrate `vitest` plugin with the editor so that selected tests (or test suites) can be run from the IDE. These require additional packages. Essentially, we'll be replacing the default builder for the `test` target with `@analogjs/vitest-angular:test`.

   ```
   $ npm i @analogjs/platform @analogjs/vite-plugin-angular @analogjs/vitest-angular jsdom vite-tsconfig-paths --save-dev
   ```

   Create the following files:
   1. `tsconfig.spec.json` in workspace folder. This will be the dedicated Typescript configuration for running unit tests. This should extend the base `tsconfig.json`, but should've the following:

      ```
      // rootDir/tsconfig.spec.json
      {
        "extends": "./tsconfig.json",
        "compilerOptions": {
          "outDir": "../../out-tsc/spec",
          "types": ["vitest/globals", "node"],
          "paths": {
            "shared": ["libs/shared"]
          }
        }
      }
      ```

      Importantly, `types` should list `vitest/globals` so that common test functions such as `describe`, `it`, `beforeEach` are available globally. Secondly, `paths` should list the source folder of the libraries so that any `spec.ts` files in a peer project use the library's `.ts` source ensuring that the library doesn't have to be built before the peer project
      tests are run.

   2. Create `vitest.config.ts` & `src/test-setup.ts` in both the `helloworld` app and `shared` library project folders.

      ```
      // vitest.config.ts
      import { defineConfig } from 'vite';

      import angular from '@analogjs/vite-plugin-angular';
      import viteTsConfigPaths from 'vite-tsconfig-paths';

      export default defineConfig(({ mode }) => ({
        plugins: [angular(), viteTsConfigPaths({ root: '../../' })],
        test: {
          globals: true,
          setupFiles: ['src/test-setup.ts'],
          environment: 'jsdom',
          include: ['src/**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}'],
          reporters: ['default'],
        },
      }));
      ```

      ```
      // src/test-setup.ts
      import '@analogjs/vitest-angular/setup-snapshots';
      import { setupTestBed } from '@analogjs/vitest-angular/setup-testbed';
      import '@angular/compiler';

      setupTestBed();
      ```

   3. Add `src/test-setup.ts` to the project's `tsconfig.spec.json`'s `files` list.

      ```
      // <project>/tsconfig.spec.json
      {
        "extends": "../../tsconfig.spec.json",
        "compilerOptions": {
          "outDir": "../../out-tsc/spec",
          "types": ["vitest/globals"]
        },
        "files": ["src/test-setup.ts"],
        "include": ["src/**/*.d.ts", "src/**/*.spec.ts"]
      }
      ```

   4. Update `angular.json`'s `test` target to use `@anglogjs/vitest-angular:test` as the builder for every app and library configuration:

      ```
      // angular.json
      ...
      "shared": {
        "architect": {
          ...
          "test": {
            "builder": "@analogjs/vitest-angular:test",
            "options": {
              "tsConfig": "libs/shared/tsconfig.spec.json"
            }
          }
        }
      }
      ```

6. Issue `ng build` and `ng test` commands for all the apps and libraries in the workspace. If you followed the instructions above to a ditto, it should all work well. Also, if you've installed the official `vitest` VSCode plugin, you should see a green play button next to your test suite's `describe` and `it` calls. If you don't, close VSCode and reopen the workspace. Sometimes the plugin doesn't detect addition of `vitest.config.ts` or changes to its contents.

## Library with sub-packages

A library can be structured as one with sub-packages. The steps to follow are very much the same as what is given above. However, since such a library's folder structure will be different, its `tsconfig.lib.json` and `tsconfig.spec.json` will have to be tweaked.

The `libs/helper` project demonstrates such a library. Points to note:

- `tsconfig.lib.json` removes the `src/` prefix for its `include` files wildcard value. Same for `tsconfig.spec.json`. Same in `vitest.config.ts`.
- `test-setup.ts` has been moved to the library root folder and `tsconfig.*.json` files have been updated accordingly.
- There's a project global `ng-package.json`, which is necessary. The project global `public-api.ts` exports a library version constant. This is not necessary, but a convention as it has to export at least one symbol.
- Each subpackage is stored as a subfolder under the project folder and they contain their own `ng-package.json` and `public-api.ts`.
- The sub-package `ng-package.json` does not include `"dest": "..."` key as this is controlled by the value in the project's `ng-package.json`.

## Key points

- Employing `vitest` independently (outside of via the Angular CLI) uses a different build pipeline than what the CLI subjects it to. The `vitest.config.ts` & `test-setup.ts` files mentioned in step 2 are aimed exactly that. By using `@analogjs/vitest-angular:test` as the test builder, we're bypassing the `ng` native mechanisms for running the unit tests in the project.

- We choose to override the default test builder, so that tests can be run both by the `ng` CLI as well as from `Vitest` editor plugin. We do this primarily to incorporate the ability to run and debug unit tests from with the IDE. That is, without having to start the app (or a demo app dedicated to test the library) in the browser. Ability to run tests from the IDE is quite powerful as it allows individual tests to be run and debugged -- all without switching context out of the editor.

- If you encouter any issues during test or build, issue the corrollary `ng {build|test}` command on the project to see if the problem exists. If the problem exists only in `ng test` and not in `ng build` it indicates an issue with `vitest` not being run with the required correct configuration. Check your `vitest.config.ts`, `test-setup.ts` & `tsconfig.spec.json`. Could be a typo (like a wrong path or missing `files: ["src/test-setup.ts"]`) in one of these files.

- The two files `tsconfig.json` and `tsconfig.spec.json` control the base configuration for production builds and test builds. This is necessary as the path aliases for libraries should point to two differenet locations for production (or `ng serve`) and unit test builds. Production builds should pick up the library code from its transpiled form whereas unit tests should pick up the actual library source files in the workspace. Thereafter all app and library `tsconfig` files derive from one of these two, depending on the scope of the config file. Project's `tsconfig.lib.json` extends `tsconfig.json` and `tsconfig.spec.json` from the same file in the workspace root.

That's it! The workspace is a proper monorepo, supporting any number of applications with code shared between them via the libraries in the same project.
